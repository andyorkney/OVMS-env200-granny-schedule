# v1.1.0 Changes - Cost Awareness

**Status:** Work In Progress (WIP)  
**Ready for testing:** Yes  
**Breaking changes:** None

---

## Summary

v1.1.0 adds cost calculation and overflow warnings WITHOUT changing any control logic from v1.0.0.

### What Changed
- ✅ Added cost calculation functions (future-proof for v1.2.0)
- ✅ Added overflow detection and warnings
- ✅ Enhanced plug-in notifications with cost info
- ✅ Enhanced status display with cost estimates
- ✅ Shows savings vs standard rate

### What Did NOT Change
- ✅ All v1.0.0 functionality intact
- ✅ Same scheduling logic
- ✅ Same SOC targeting
- ✅ Same event handling
- ✅ Same stability guarantees

---

## New Features

### 1. Cost Calculation on Plug-In

**Before (v1.0.0):**
```
[21:05] Plugged in at 40%. Will charge to 85% during 23:30-05:30.
```

**After (v1.1.0):**
```
[21:05] Plugged in at 40%. Will charge to 85% during 23:30-05:30.
Need 15.3 kWh (~8.5h).
Est. cost: £1.07 (saving £3.40)
```

**With overflow warning:**
```
[21:05] Plugged in at 30%. Will charge to 90% during 23:30-05:30.
Need 20.4 kWh (~11.3h).
Est. cost: £3.45 ⚠️
CHEAP: 10.8 kWh @ £0.76
OVERFLOW: 9.6 kWh @ £2.80
```

### 2. Cost Information in Status

**Before (v1.0.0):**
```
=== Smart Charging v1.0.0 ===

Battery:
  SOC: 40% (target 85%)
  SOH: 86%
  Capacity: 34.4 kWh

Status:
  Plugged in: Yes
  Charging: No

Scheduling:
  Mode: Scheduled (wait for cheap window)
  Cheap window: 23:30 - 05:30
  In window now: No
```

**After (v1.1.0):**
```
=== Smart Charging v1.1.0 ===

Battery:
  SOC: 40% (target 85%)
  SOH: 86%
  Capacity: 34.4 kWh

Status:
  Plugged in: Yes
  Charging: No

Scheduling:
  Mode: Scheduled (wait for cheap window)
  Cheap window: 23:30 - 05:30
  In window now: No

Cost Estimate:
  Need: 15.3 kWh (~8.5h @ 1.8kW)
  Total cost: £1.07
  ✅ Will complete in cheap window
  Saving: £3.40 vs standard rate
```

**With overflow:**
```
Cost Estimate:
  Need: 20.4 kWh (~11.3h @ 1.8kW)
  Total cost: £3.45
  ⚠️ WARNING: Will extend past window end
    Cheap: 10.8 kWh @ £0.76
    Overflow: 9.6 kWh @ £2.69
```

---

## Technical Implementation

### Future-Proof Design

The cost calculation function accepts time ranges, making it ready for v1.2.0:

```javascript
// v1.1.0 (fixed schedule - always starts at window start)
var start_time = window_start_time;
var end_time = start_time + charge_duration;
var cost = calculateCostForTimeRange(start_time, end_time, kwh_needed);

// v1.2.0 (ready-by - may start before window)
var start_time = calculateOptimalStart(ready_by_time); // NEW in v1.2.0
var end_time = start_time + charge_duration;
var cost = calculateCostForTimeRange(start_time, end_time, kwh_needed); // Same function!
```

**This means v1.2.0 won't need to rewrite cost calculations!** ✅

### Cost Calculation Logic

1. **Calculate time in each period:**
   - Pre-window (before 23:30)
   - Cheap window (23:30-05:30)
   - Post-window (after 05:30)

2. **Distribute kWh proportionally:**
   - If charge takes 10h and 6h are in window:
   - 60% of kWh at cheap rate
   - 40% of kWh at standard rate

3. **Calculate costs:**
   - Pre-window kWh × standard rate
   - Cheap kWh × cheap rate
   - Post-window kWh × standard rate

4. **Calculate savings:**
   - What it would cost at standard rate - actual cost

---

## Testing Plan

### Phase 1: Syntax and Load Testing
```bash
# 1. Upload to OVMS
scp charging-v1.1.0-WIP.js root@ovms:/store/scripts/lib/charging-test.js

# 2. Test load
ssh root@ovms
script eval 'require("lib/charging-test")'
# Should load without errors

# 3. Check status
script eval charging.status()
# Should show cost estimate section
```

### Phase 2: Cost Calculation Verification

**Test Case 1: All in Window**
```bash
# Setup
script eval charging.setTarget(85)
script eval charging.setChargeRate(1.8)
script eval charging.setRates(0.07, 0.292)

# At 40% SOC, need 15.3 kWh, takes 8.5h
# Window is 6h long
# Expected: All in window, cost £1.07

script eval charging.status()
# Verify: Shows "Will complete in cheap window"
```

**Test Case 2: Overflow**
```bash
# At 30% SOC with 1.8kW charger
# Need 20.4 kWh, takes 11.3h
# Window is 6h
# Expected: 6h in window (10.8 kWh), 5.3h overflow (9.6 kWh)

script eval charging.setTarget(90)
# Manually calculate SOC to need ~20 kWh

script eval charging.status()
# Verify: Shows overflow warning
```

**Test Case 3: Cost Accuracy**
```bash
# Verify calculations match manual math:
# 15.3 kWh × £0.07 = £1.071
# 15.3 kWh × £0.292 = £4.468
# Savings = £4.468 - £1.071 = £3.397

# Should show ~£1.07 cost and ~£3.40 savings
```

### Phase 3: Plug-In Notification Testing

```bash
# 1. Configure scheduling
script eval charging.enable()
script eval charging.setTarget(85)

# 2. Plug in vehicle (outside window)
# Expected: Notification with cost info

# 3. Check notification includes:
# - kWh needed
# - Estimated hours
# - Estimated cost
# - Overflow warning (if applicable)
# - Savings (if no overflow)
```

### Phase 4: Functional Regression Testing

**Critical: Verify v1.0.0 functionality unchanged**

```bash
# 1. Test scheduled charging still works
# - Plugs in outside window → stops immediately ✅
# - Waits for 23:30 ✅
# - Starts automatically ✅
# - Stops at target SOC ✅

# 2. Test enable/disable
script eval charging.disable()
# Plug in → charges immediately ✅

script eval charging.enable()
# Plug in → waits for window ✅

# 3. Test manual control
script eval charging.start()
# Starts charging ✅

script eval charging.stop()
# Stops charging ✅
```

### Phase 5: Overnight Test

**Full integration test like v1.0.0:**

1. Set target to 85%
2. Enable scheduling
3. Plug in at 21:00 with 40% SOC
4. Verify cost notification
5. Wait for 23:30 start
6. Verify charges to 85%
7. Check actual costs next day

---

## Known Issues / Limitations

### 1. Cost Calculation is Approximate

**Why:** Assumes constant charge rate

**Reality:** EV charge rates vary:
- Fast at low SOC
- Slower at high SOC
- Temperature affects rate

**Impact:** Estimate may be ±10% of actual

**Mitigation:** 
- Show as "estimate"
- Users understand it's approximate
- Good enough for decision-making

### 2. Overnight Crossing Midnight

**Complexity:** Charging from 23:30 to 02:30 crosses midnight

**Status:** Logic handles this correctly

**Testing:** Verify calculations with midnight-crossing scenarios

### 3. No Historical Cost Tracking

**v1.1.0:** Only shows estimates, no history

**Future:** v1.3.0 could add cost history tracking

---

## Git Workflow for v1.1.0

### Step 1: Test Locally First

```bash
# On OVMS module:
scp charging-v1.1.0-WIP.js root@ovms:/store/scripts/lib/charging-test.js

# Test thoroughly
# Document test results
# Fix any bugs
```

### Step 2: When Tests Pass

```bash
# Rename WIP to final
mv charging-v1.1.0-WIP.js charging-v1.1.0.js

# Update working symlink
cp charging-v1.1.0.js charging.js
```

### Step 3: Git Commit

```bash
# Create feature branch
git checkout -b feature/v1.1.0-cost-awareness

# Add files
git add src/charging-v1.1.0.js
git add src/charging.js  # Updated symlink
git add docs/

# Commit with clear message
git commit -m "v1.1.0: Add cost awareness

Features:
- Cost calculations on plug-in
- Overflow warnings
- Enhanced status display
- Savings calculations

Changes:
- Added calculateCostForTimeRange() (future-proof)
- Enhanced onPlugIn() notification
- Enhanced status() display

Testing:
- All v1.0.0 functionality verified unchanged
- Cost calculations verified accurate (±10%)
- Overflow detection working
- Notifications showing correctly

Fixes: None (new features only)
"

# Push to GitHub
git push origin feature/v1.1.0-cost-awareness
```

### Step 4: Pull Request

Create PR on GitHub:
- Title: "v1.1.0: Cost Awareness"
- Description: Summary of changes
- Link to test results
- Request review (or self-review if solo)

### Step 5: Merge and Tag

```bash
# Merge to main
git checkout main
git merge feature/v1.1.0-cost-awareness

# Tag release
git tag -a v1.1.0 -m "v1.1.0: Cost awareness

- Cost calculations and estimates
- Overflow warnings
- Enhanced notifications
- Future-proof for v1.2.0"

# Push with tags
git push origin main --tags
```

### Step 6: Update Documentation

```bash
# Update CHANGELOG.md
# Update README.md (version badges)
# Update REQUIREMENTS-VERIFICATION (mark cost features as implemented)

git add docs/
git commit -m "docs: Update for v1.1.0 release"
git push origin main
```

---

## Testing Checklist

### Before Committing

- [ ] Syntax check passes
- [ ] Loads without errors
- [ ] Status displays correctly
- [ ] Cost calculations verified
- [ ] Overflow detection works
- [ ] Plug-in notifications enhanced
- [ ] All v1.0.0 functionality unchanged
- [ ] No performance issues
- [ ] Notifications working
- [ ] Documentation updated

### Before Merging to Main

- [ ] Full overnight test passed
- [ ] Cost estimates within ±10% of actual
- [ ] No regressions from v1.0.0
- [ ] Code reviewed
- [ ] Documentation complete
- [ ] Changelog updated

---

## Rollback Plan

If v1.1.0 has issues:

```bash
# Option 1: Quick fix
# Edit charging-v1.1.0.js
# Test fix
# Commit fix

# Option 2: Rollback to v1.0.0
scp charging-v1.0.0-TESTED-WORKING.js root@ovms:/store/scripts/lib/charging.js
script reload

# On GitHub:
git revert HEAD
# Or
git checkout v1.0.0 -- src/charging.js
```

**v1.0.0 is always safe baseline!**

---

## Success Criteria

v1.1.0 is ready for release when:

✅ All tests pass  
✅ Cost estimates reasonable (±10%)  
✅ Overflow warnings accurate  
✅ No v1.0.0 regressions  
✅ Stable overnight test  
✅ Documentation complete  
✅ User feedback positive  

---

## Next Steps After v1.1.0

**v1.2.0 Planning:**
- Add `setReadyBy()` function
- Add `calculateOptimalStart()` function
- Use existing `calculateCostForTimeRange()` (no changes needed!)
- Test extensively with ready-by scenarios

**Timeline:**
- v1.1.0 testing: 1-2 weeks
- v1.1.0 release: When tests pass
- v1.2.0 development: Start after v1.1.0 stable

---

**Questions? Issues? Check with Andy before proceeding!**
