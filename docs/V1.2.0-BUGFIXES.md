# v1.2.0 Bugfixes - 2025-11-26 20:10

## Issues Found During Real-World Testing

### Bug #1: Time Formatting Shows Decimals üêõ

**Problem:**
```
Will start: 22:45.20000000000027
```

**Root Cause:**
Floating-point minutes not being floored to integers before passing to `formatTime()`

**Fix:**
```javascript
// ‚ùå BEFORE
var start_time = formatTime(
  Math.floor(optimal.start_minutes / 60) % 24,
  optimal.start_minutes % 60  // Returns 45.2
);

// ‚úÖ AFTER
var start_time = formatTime(
  Math.floor(optimal.start_minutes / 60) % 24,
  Math.floor(optimal.start_minutes % 60)  // Returns 45
);
```

**Locations Fixed:**
- Line 724: onPlugIn() - start_time
- Line 737: onPlugIn() - finish_time
- Line 1108: status() - start_time
- Line 1112: status() - finish_time

**Result:**
```
Will start: 22:45  ‚úÖ
Will finish: 08:30 ‚úÖ
```

---

### Bug #2: App Notification Missing Ready-By Details üì±

**Problem:**
App shows basic summary without timing:
```
Smart Charging v1.2.0
SOC: 29% ‚Üí 80%
Plugged: Yes, Charging: No
Mode: Scheduled
Cost: ¬£2.73 ‚ö†Ô∏è Overflow
```

User can't see WHEN it will start/finish!

**Fix:**
Enhanced app notification to include timing when ready-by is enabled:

```javascript
if (ready_h !== 0 || ready_m !== 0) {
  // Ready-by mode - show timing
  var optimal = calculateOptimalStart();
  var start_time = formatTime(...);
  var finish_time = formatTime(...);
  
  summary += "\nStart: " + start_time + ", Finish: " + finish_time;
  summary += "\nCost: ¬£" + cost_info.total_cost.toFixed(2);
  if (cost_info.has_overflow) {
    summary += " (PRE+CHEAP+POST)";
  }
}
```

**Result:**
```
Smart Charging v1.2.0
SOC: 29% ‚Üí 80%
Plugged: Yes, Charging: No
Mode: Scheduled
Start: 22:45, Finish: 08:30
Cost: ¬£2.73 (PRE+CHEAP+POST)
```

---

## New OVMS Quirk Documented üìö

### Quirk #0: NO SPACES IN FUNCTION ARGUMENTS

**Problem:**
```bash
script eval charging.setReadyBy(8, 30)  # ‚ùå FAILS
```

**Why:**
OVMS CLI parser treats ALL spaces as command separators, even inside parentheses.

**Solution:**
```bash
script eval charging.setReadyBy(8,30)  # ‚úÖ WORKS
```

**Documentation Updated:**
- `/mnt/project/OVMS-GUIDELINES.md` - Added as CRITICAL QUIRK #1
- `OVMS-QUICK-REFERENCE.md` - Added as gotcha #0 (top of list)
- Added to "Before Every Commit" checklist
- Added to debugging checklist

---

## Testing Results

**Your Real Test Case:**
- SOC: 29% ‚Üí 80%
- Need: 17.5 kWh (~9.7h @ 1.8kW)
- Ready-by: 08:30
- Window: 23:30-05:30

**Calculated Schedule:**
- ‚úÖ Start: 22:45 (0.7h before window)
- ‚úÖ Finish: 08:30 (exactly at deadline)
- ‚úÖ Cost: ¬£2.73 breakdown shown
  - PRE: 1.3 kWh @ ¬£0.39
  - CHEAP: 10.8 kWh @ ¬£0.76
  - POST: 5.4 kWh @ ¬£1.58

**Perfect!** The system correctly calculated:
1. Must start early (22:45 vs 23:30 window start)
2. Will finish exactly at deadline (08:30)
3. Accurate cost prediction with breakdown

---

## Files Updated

### Code
- `/home/claude/charging-v1.2.0-WIP.js` (fixed)
- `/mnt/user-data/outputs/charging-v1.2.0-WIP.js` (deployed)

### Documentation
- `/mnt/project/OVMS-GUIDELINES.md` (added quirk)
- `OVMS-QUICK-REFERENCE.md` (added quirk)

---

## Deployment Instructions

```bash
# Upload fixed version
scp /mnt/user-data/outputs/charging-v1.2.0-WIP.js root@ovms:/store/scripts/lib/charging.js

# Reload
ssh root@ovms
script reload

# Test
script eval "charging.status()"
```

---

## Expected Results After Update

**Console:**
```
Will start: 22:45          # ‚úÖ No decimals
Will finish: 08:30         # ‚úÖ Clean formatting
```

**App Notification:**
```
Smart Charging v1.2.0
SOC: 29% ‚Üí 80%
Plugged: Yes, Charging: No
Mode: Scheduled
Start: 22:45, Finish: 08:30    # ‚úÖ NEW!
Cost: ¬£2.73 (PRE+CHEAP+POST)   # ‚úÖ Clear breakdown indicator
```

---

## Status

- [x] Bug #1 (time formatting) - FIXED
- [x] Bug #2 (app notification) - FIXED  
- [x] OVMS quirk documented
- [x] Syntax validated
- [x] Files deployed to outputs
- [ ] Deploy to OVMS
- [ ] Test real charging cycle

---

## Next Steps

1. Deploy fixed version to OVMS
2. Run `charging.status()` to verify time formatting
3. Wait for app notification to verify enhanced summary
4. Monitor tonight's charging cycle (should start at 22:45!)

---

**Excellent find on the spaces issue!** That's now documented as the #0 gotcha. üéØ
